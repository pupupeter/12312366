<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»æ§å° - ç”¨æˆ¶ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .navbar-brand {
            font-size: 1.5em;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            margin: 0 auto 20px;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
        }

        .avatar-upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.3em;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .profile-avatar-large:hover .avatar-upload-overlay {
            opacity: 1;
        }

        #avatarInput {
            display: none;
        }

        .btn-logout {
            background: rgba(255, 107, 107, 0.8);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s, transform 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255, 107, 107, 1);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .welcome-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .welcome-section h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .welcome-section p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .card h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .card p {
            opacity: 0.9;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            margin-top: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
        }

        .message.error {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
        }

        /* æ¨¡æ…‹è¦–çª—æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 50px auto;
            padding: 0;
            border-radius: 20px;
            max-width: 600px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        .close {
            color: white;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            line-height: 1;
        }

        .close:hover {
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #5568d3, #653a8b);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .info-label {
            font-weight: bold;
            opacity: 0.8;
        }

        .info-value {
            font-weight: bold;
        }

        .activity-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .activity-description {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .activity-time {
            opacity: 0.7;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .help-section {
            margin-bottom: 30px;
        }

        .help-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .help-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .help-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .help-item-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-item-content {
            display: none;
            opacity: 0.9;
            line-height: 1.6;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .help-item.active .help-item-content {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .welcome-section h1 {
                font-size: 2em;
            }

            .modal-content {
                margin: 20px;
                max-width: calc(100% - 40px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="navbar-brand" data-i18n="nav_title">{{ t.nav_title }}</div>
            <div class="navbar-user">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <span id="username">{{ username }}</span>
                </div>
                <button class="btn-logout" onclick="logout()" data-i18n="logout">{{ t.logout }}</button>
            </div>
        </nav>

        <div id="message" class="message"></div>

        <div class="welcome-section">
            <h1><span data-i18n="welcome_back">{{ t.welcome_back }}</span>,<span id="welcomeUsername">{{ username }}</span>!</h1>
            <p data-i18n="login_success">{{ t.login_success }}</p>
        </div>

        <div class="cards-grid">
            <div class="card" onclick="openRailwayApp('korean')">
                <div class="card-icon">ğŸ“°</div>
                <h3 data-i18n="korean_news_title">{{ t.korean_news_title }}</h3>
                <p data-i18n="korean_news_desc">{{ t.korean_news_desc }}</p>
            </div>

            <div class="card" onclick="openRailwayApp('chinese')">
                <div class="card-icon">ğŸ“š</div>
                <h3 data-i18n="chinese_vocab_title">{{ t.chinese_vocab_title }}</h3>
                <p data-i18n="chinese_vocab_desc">{{ t.chinese_vocab_desc }}</p>
            </div>

            <div class="card" onclick="window.open('/tts', '_blank')">
                <div class="card-icon">ğŸ™ï¸</div>
                <h3 data-i18n="ai_tts_title">{{ t.ai_tts_title }}</h3>
                <p data-i18n="ai_tts_desc">{{ t.ai_tts_desc }}</p>
            </div>

            <div class="card" onclick="openGamesModal()">
                <div class="card-icon">ğŸ®</div>
                <h3 data-i18n="word_games_title">{{ t.word_games_title }}</h3>
                <p data-i18n="word_games_desc">{{ t.word_games_desc }}</p>
            </div>

            <div class="card" onclick="openProfileModal()">
                <div class="card-icon">ğŸ‘¤</div>
                <h3 data-i18n="profile_title">{{ t.profile_title }}</h3>
                <p data-i18n="profile_desc">{{ t.profile_desc }}</p>
            </div>

            <div class="card" onclick="openSettingsModal()">
                <div class="card-icon">âš™ï¸</div>
                <h3 data-i18n="settings_title">{{ t.settings_title }}</h3>
                <p data-i18n="settings_desc">{{ t.settings_desc }}</p>
            </div>

            <div class="card" onclick="openActivitiesModal()">
                <div class="card-icon">ğŸ“Š</div>
                <h3 data-i18n="activities_title">{{ t.activities_title }}</h3>
                <p data-i18n="activities_desc">{{ t.activities_desc }}</p>
            </div>

            <div class="card" onclick="openHelpModal()">
                <div class="card-icon">â“</div>
                <h3 data-i18n="help_title">{{ t.help_title }}</h3>
                <p data-i18n="help_desc">{{ t.help_desc }}</p>
            </div>
        </div>

        <div class="stats-section">
            <h2 data-i18n="stats_title">{{ t.stats_title }}</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="loginCount">-</div>
                    <div class="stat-label" data-i18n="login_count">{{ t.login_count }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalActivities">-</div>
                    <div class="stat-label" data-i18n="total_activities">{{ t.total_activities }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="daysActive">-</div>
                    <div class="stat-label" data-i18n="days_active">{{ t.days_active }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="currentTime">--:--</div>
                    <div class="stat-label" data-i18n="current_time">{{ t.current_time }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å€‹äººè³‡æ–™æ¨¡æ…‹è¦–çª— -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ‘¤ å€‹äººè³‡æ–™</h2>
                <span class="close" onclick="closeModal('profileModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- é ­åƒä¸Šå‚³å€åŸŸ -->
                <div class="profile-avatar-large" id="profileAvatarLarge" onclick="document.getElementById('avatarInput').click()">
                    <span id="profileAvatarText">?</span>
                    <div class="avatar-upload-overlay">é»æ“Šæ›´æ›é ­åƒ</div>
                </div>
                <input type="file" id="avatarInput" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp" onchange="handleAvatarUpload(event)">

                <div class="form-group">
                    <label>ç”¨æˆ¶åç¨±</label>
                    <input type="text" id="profileUsername" disabled>
                </div>
                <div class="form-group">
                    <label>é›»å­éƒµä»¶</label>
                    <input type="email" id="profileEmail" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶">
                </div>
                <div class="info-row">
                    <span class="info-label">è¨»å†Šæ™‚é–“</span>
                    <span class="info-value" id="profileCreatedAt">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æœ€å¾Œç™»å…¥</span>
                    <span class="info-value" id="profileLastLogin">-</span>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="updateProfile()">å„²å­˜è®Šæ›´</button>
                    <button class="btn" onclick="openChangePasswordModal()">ä¿®æ”¹å¯†ç¢¼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç¢¼æ¨¡æ…‹è¦–çª— -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ”’ ä¿®æ”¹å¯†ç¢¼</h2>
                <span class="close" onclick="closeModal('passwordModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>èˆŠå¯†ç¢¼</label>
                    <input type="password" id="oldPassword" placeholder="è«‹è¼¸å…¥èˆŠå¯†ç¢¼">
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç¢¼</label>
                    <input type="password" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ (è‡³å°‘ 6 å€‹å­—å…ƒ)">
                </div>
                <div class="form-group">
                    <label>ç¢ºèªæ–°å¯†ç¢¼</label>
                    <input type="password" id="confirmPassword" placeholder="è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼">
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="changePassword()">ç¢ºèªä¿®æ”¹</button>
                    <button class="btn" onclick="closeModal('passwordModal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç³»çµ±è¨­å®šæ¨¡æ…‹è¦–çª— -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
                <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 15px;">é€šçŸ¥è¨­å®š</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="settingNotifications">
                    <label for="settingNotifications">å•Ÿç”¨ç³»çµ±é€šçŸ¥</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="settingEmailNotifications">
                    <label for="settingEmailNotifications">å•Ÿç”¨é›»å­éƒµä»¶é€šçŸ¥</label>
                </div>

                <h3 style="margin: 25px 0 15px;">ä»‹é¢è¨­å®š</h3>
                <div class="form-group">
                    <label>ä¸»é¡Œ</label>
                    <select id="settingTheme">
                        <option value="default">é è¨­ä¸»é¡Œ</option>
                        <option value="dark">æ·±è‰²ä¸»é¡Œ</option>
                        <option value="light">æ·ºè‰²ä¸»é¡Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>èªè¨€</label>
                    <select id="settingLanguage">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                        <option value="en">English</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </div>

                <div style="margin-top: 25px;">
                    <button class="btn btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
                    <button class="btn" onclick="closeModal('settingsModal')">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ´»å‹•è¨˜éŒ„æ¨¡æ…‹è¦–çª— -->
    <div id="activitiesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“Š æ´»å‹•è¨˜éŒ„</h2>
                <span class="close" onclick="closeModal('activitiesModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="activitiesList">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- éŠæˆ²é¸æ“‡æ¨¡æ…‹è¦–çª— -->
    <div id="gamesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ® å–®å­—è¤‡ç¿’éŠæˆ²</h2>
                <span class="close" onclick="closeModal('gamesModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; opacity: 0.9;">é¸æ“‡ä½ æƒ³è¤‡ç¿’çš„èªè¨€ï¼š</p>

                <div class="card" onclick="openRailwayApp('korean/review')" style="cursor: pointer; margin-bottom: 15px;">
                    <div class="card-icon">ğŸ‡°ğŸ‡·</div>
                    <h3>éŸ“æ–‡å–®å­—éŠæˆ²</h3>
                    <p>è¤‡ç¿’ä½ æ”¶è—çš„éŸ“æ–‡å–®å­—</p>
                </div>

                <div class="card" onclick="openRailwayApp('chinese/review')" style="cursor: pointer;">
                    <div class="card-icon">ğŸ‡¨ğŸ‡³</div>
                    <h3>ä¸­æ–‡å–®å­—éŠæˆ²</h3>
                    <p>è¤‡ç¿’ä½ æ”¶è—çš„ä¸­æ–‡è©å½™</p>
                </div>
            </div>
        </div>
    </div>

    <!-- èªªæ˜ä¸­å¿ƒæ¨¡æ…‹è¦–çª— -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â“ èªªæ˜ä¸­å¿ƒ</h2>
                <span class="close" onclick="closeModal('helpModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>ğŸš€ å¿«é€Ÿé–‹å§‹</h3>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>å¦‚ä½•ä½¿ç”¨éŸ“æ–‡æ–°èçŸ¥è­˜åœ–è­œ?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            1. é»æ“Šä¸»æ§å°çš„ã€ŒéŸ“æ–‡æ–°èçŸ¥è­˜åœ–è­œã€å¡ç‰‡<br>
                            2. åœ¨è¼¸å…¥æ¡†ä¸­è²¼ä¸ŠéŸ“æ–‡æ–°èæ–‡ç« çš„ç¶²å€<br>
                            3. é»æ“Šã€Œé–‹å§‹åˆ†æã€æŒ‰éˆ•<br>
                            4. ç­‰å¾…ç³»çµ±ç”ŸæˆçŸ¥è­˜åœ–è­œ (ç´„éœ€ 30-60 ç§’)<br>
                            5. åœ¨åœ–è­œä¸­å¯ä»¥æŸ¥çœ‹è©å½™é—œä¿‚ã€å®šç¾©å’Œä¾‹å¥<br>
                            6. é›™æ“Šç¯€é»å¯ä»¥æ”¶è—å–®è©
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>å¦‚ä½•ä½¿ç”¨ä¸­æ–‡è©å½™çŸ¥è­˜åœ–è­œ?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            æ“ä½œæ–¹å¼èˆ‡éŸ“æ–‡æ–°èåœ–è­œç›¸åŒ,ä½†é‡å°ä¸­æ–‡å…§å®¹é€²è¡Œåˆ†æã€‚ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥è©å½™é›£åº¦ç­‰ç´š,ä¸¦æ¨™è¨» HSK ç­‰ç´šã€‚
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>å¦‚ä½•ä½¿ç”¨ AI èªéŸ³å°è©±ç”Ÿæˆå™¨?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            1. é»æ“Šã€ŒAI èªéŸ³å°è©±ç”Ÿæˆå™¨ã€å¡ç‰‡<br>
                            2. é¸æ“‡ã€Œå¾ç¶²å€ç”Ÿæˆã€æˆ–ã€Œæ‰‹å‹•è¼¸å…¥å°è©±ã€<br>
                            3. é¸æ“‡ç›®æ¨™èªè¨€ (æ”¯æ´ 16 ç¨®èªè¨€)<br>
                            4. é¸æ“‡èªªè©±è€…èªéŸ³ (Kore, Puck, Charon ç­‰)<br>
                            5. é»æ“Šã€Œç”ŸæˆéŸ³é »ã€<br>
                            6. ç­‰å¾…ç”Ÿæˆå®Œæˆå¾Œæ’­æ”¾æˆ–ä¸‹è¼‰ WAV æª”æ¡ˆ
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>ğŸ”§ å¸¸è¦‹å•é¡Œ</h3>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>ç‚ºä»€éº¼ç”ŸæˆçŸ¥è­˜åœ–è­œå¾ˆæ…¢?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            ç³»çµ±éœ€è¦ä¸‹è¼‰ç¶²é å…§å®¹ã€ä½¿ç”¨ AI æ¨¡å‹åˆ†ææ–‡æœ¬ã€æå–é—œéµè©å½™ä¸¦å»ºç«‹é—œä¿‚åœ–ã€‚æ•´å€‹éç¨‹é€šå¸¸éœ€è¦ 30-60 ç§’,è«‹è€å¿ƒç­‰å¾…ã€‚å¦‚æœè¶…é 2 åˆ†é˜æ²’æœ‰å›æ‡‰,è«‹é‡æ–°æ•´ç†é é¢å†è©¦ä¸€æ¬¡ã€‚
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>æ”¶è—çš„å–®è©å„²å­˜åœ¨å“ªè£¡?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            æ”¶è—çš„å–®è©å„²å­˜åœ¨ä¼ºæœå™¨çš„ JSON æª”æ¡ˆä¸­ (saved_words.json å’Œ saved_words_chinese.json)ã€‚æ‚¨å¯ä»¥åœ¨ç³»çµ±ä¸­çš„ã€Œè¤‡ç¿’ã€é é¢æŸ¥çœ‹æ‰€æœ‰æ”¶è—çš„å–®è©ã€‚
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>å¦‚ä½•ä¿®æ”¹å€‹äººè³‡æ–™?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            é»æ“Šä¸»æ§å°çš„ã€Œå€‹äººè³‡æ–™ã€å¡ç‰‡,æ‚¨å¯ä»¥ä¿®æ”¹é›»å­éƒµä»¶å’Œå¯†ç¢¼ã€‚ç”¨æˆ¶åç¨±åœ¨è¨»å†Šå¾Œç„¡æ³•ä¿®æ”¹ã€‚
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>å¿˜è¨˜å¯†ç¢¼æ€éº¼è¾¦?</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            ç›®å‰ç³»çµ±å°šæœªæä¾›å¯†ç¢¼é‡è¨­åŠŸèƒ½ã€‚å¦‚æœå¿˜è¨˜å¯†ç¢¼,è«‹è¯çµ¡ç³»çµ±ç®¡ç†å“¡å”åŠ©é‡è¨­ã€‚
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>ğŸ’¡ æŠ€è¡“æ”¯æ´</h3>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>ç³»çµ±éœ€æ±‚</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            - ç€è¦½å™¨: Chrome, Firefox, Safari æˆ– Edge æœ€æ–°ç‰ˆæœ¬<br>
                            - ç¶²è·¯é€£ç·š: ç©©å®šçš„ç¶²è·¯é€£ç·š<br>
                            - è¢å¹•è§£æåº¦: å»ºè­° 1280x720 ä»¥ä¸Š<br>
                            - JavaScript: å¿…é ˆå•Ÿç”¨
                        </div>
                    </div>
                    <div class="help-item" onclick="toggleHelp(this)">
                        <div class="help-item-title">
                            <span>æ”¯æ´çš„å…§å®¹ä¾†æº</span>
                            <span>â–¼</span>
                        </div>
                        <div class="help-item-content">
                            - éŸ“æ–‡æ–°è: æ”¯æ´å¤§éƒ¨åˆ†éŸ“åœ‹æ–°èç¶²ç«™<br>
                            - ä¸­æ–‡æ–‡ç« : æ”¯æ´ç¹é«”å’Œç°¡é«”ä¸­æ–‡ç¶²é <br>
                            - TTS: æ”¯æ´å…¬é–‹å¯å­˜å–çš„ç¶²é å…§å®¹<br>
                            æ³¨æ„: æŸäº›ç¶²ç«™å¯èƒ½æœ‰åçˆ¬èŸ²æ©Ÿåˆ¶,å°è‡´ç„¡æ³•æ“·å–å…§å®¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const username = "{{ username }}";
        const messageDiv = document.getElementById('message');
        let currentLang = "{{ lang }}";

        // ç¿»è­¯å­—å…¸ (å¾å¾Œç«¯å‚³å…¥)
        const translations = {{ t|tojson }};

        // å…¨å±€è®Šé‡å­˜å„²é ­åƒ
        let currentAvatar = null;

        // è¨­å®šç”¨æˆ¶é ­åƒï¼ˆé¡¯ç¤ºç¬¬ä¸€å€‹å­—æˆ–åœ–ç‰‡ï¼‰
        const userAvatar = document.getElementById('userAvatar');

        // è¼‰å…¥ç”¨æˆ¶é ­åƒ
        async function loadUserAvatar() {
            try {
                const response = await fetch('/api/user/avatar');
                const data = await response.json();

                if (data.success && data.avatar) {
                    currentAvatar = data.avatar;
                    // è¨­ç½®å°èˆªæ¬„é ­åƒ
                    userAvatar.style.backgroundImage = `url(${data.avatar})`;
                    userAvatar.textContent = '';
                } else {
                    // æ²’æœ‰é ­åƒï¼Œé¡¯ç¤ºé¦–å­—æ¯
                    userAvatar.textContent = username.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('è¼‰å…¥é ­åƒå¤±æ•—:', error);
                userAvatar.textContent = username.charAt(0).toUpperCase();
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        loadUserAvatar();

        // è™•ç†é ­åƒä¸Šå‚³
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æª¢æŸ¥æ–‡ä»¶é¡å‹
            if (!file.type.startsWith('image/')) {
                showMessage('è«‹ä¸Šå‚³åœ–ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            // æª¢æŸ¥æ–‡ä»¶å¤§å° (2MB)
            if (file.size > 2 * 1024 * 1024) {
                showMessage('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 2MB', 'error');
                return;
            }

            // è®€å–æ–‡ä»¶ä¸¦è½‰æ›ç‚º base64
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Image = e.target.result;

                try {
                    const response = await fetch('/api/user/avatar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ avatar: base64Image })
                    });

                    const data = await response.json();

                    if (data.success) {
                        currentAvatar = base64Image;
                        // æ›´æ–°æ‰€æœ‰é ­åƒé¡¯ç¤º
                        updateAvatarDisplay(base64Image);
                        showMessage('é ­åƒæ›´æ–°æˆåŠŸ', 'success');
                    } else {
                        showMessage(data.message || 'ä¸Šå‚³å¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('ä¸Šå‚³é ­åƒå¤±æ•—:', error);
                    showMessage('ä¸Šå‚³å¤±æ•—,è«‹é‡è©¦', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        // æ›´æ–°æ‰€æœ‰é ­åƒé¡¯ç¤º
        function updateAvatarDisplay(avatarData) {
            // æ›´æ–°å°èˆªæ¬„é ­åƒ
            userAvatar.style.backgroundImage = `url(${avatarData})`;
            userAvatar.textContent = '';

            // æ›´æ–°å€‹äººè³‡æ–™æ¨¡æ…‹çª—å£é ­åƒ
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            if (profileAvatarLarge) {
                profileAvatarLarge.style.backgroundImage = `url(${avatarData})`;
                document.getElementById('profileAvatarText').textContent = '';
            }
        }

        // æ›´æ–°é é¢èªè¨€
        function updatePageLanguage(newTranslations) {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (newTranslations[key]) {
                    element.textContent = newTranslations[key];
                }
            });
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            if (confirm(translations.logout_confirm || 'ç¢ºå®šè¦ç™»å‡ºå—?')) {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST'
                    });

                    const data = await response.json();

                    if (data.success) {
                        showMessage(translations.logout_success || 'ç™»å‡ºæˆåŠŸ,æ­£åœ¨è·³è½‰...', 'success');
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 1000);
                    } else {
                        showMessage(translations.logout_failed || 'ç™»å‡ºå¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('ç™»å‡ºéŒ¯èª¤:', error);
                    showMessage(translations.logout_failed || 'ç™»å‡ºå¤±æ•—,è«‹é‡è©¦', 'error');
                }
            }
        }

        // æ›´æ–°æ™‚é–“
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
        async function loadStats() {
            try {
                const response = await fetch('/api/user/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('loginCount').textContent = data.stats.login_count;
                    document.getElementById('totalActivities').textContent = data.stats.total_activities;
                    document.getElementById('daysActive').textContent = data.stats.days_active;
                }
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // æ¨¡æ…‹è¦–çª—æ§åˆ¶
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // é»æ“Šè¦–çª—å¤–é—œé–‰
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // é–‹å•Ÿå€‹äººè³‡æ–™
        async function openProfileModal() {
            openModal('profileModal');

            // è¨­ç½®é ­åƒé¡¯ç¤º
            const profileAvatarLarge = document.getElementById('profileAvatarLarge');
            const profileAvatarText = document.getElementById('profileAvatarText');

            if (currentAvatar) {
                profileAvatarLarge.style.backgroundImage = `url(${currentAvatar})`;
                profileAvatarText.textContent = '';
            } else {
                profileAvatarLarge.style.backgroundImage = '';
                profileAvatarText.textContent = username.charAt(0).toUpperCase();
            }

            try {
                const response = await fetch('/api/user/profile');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('profileUsername').value = data.user.username;
                    document.getElementById('profileEmail').value = data.user.email || '';
                    document.getElementById('profileCreatedAt').textContent =
                        data.user.created_at ? new Date(data.user.created_at).toLocaleString('zh-TW') : '-';
                    document.getElementById('profileLastLogin').textContent =
                        data.user.last_login ? new Date(data.user.last_login).toLocaleString('zh-TW') : '-';
                }
            } catch (error) {
                console.error('è¼‰å…¥å€‹äººè³‡æ–™å¤±æ•—:', error);
                showMessage('è¼‰å…¥è³‡æ–™å¤±æ•—', 'error');
            }
        }

        // æ›´æ–°å€‹äººè³‡æ–™
        async function updateProfile() {
            const email = document.getElementById('profileEmail').value.trim();

            try {
                const response = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('è³‡æ–™æ›´æ–°æˆåŠŸ', 'success');
                } else {
                    showMessage(data.message || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('æ›´æ–°è³‡æ–™å¤±æ•—:', error);
                showMessage('æ›´æ–°å¤±æ•—,è«‹é‡è©¦', 'error');
            }
        }

        // é–‹å•Ÿä¿®æ”¹å¯†ç¢¼
        function openChangePasswordModal() {
            closeModal('profileModal');
            openModal('passwordModal');
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // ä¿®æ”¹å¯†ç¢¼
        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showMessage('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showMessage('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç¬¦', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ', 'error');
                return;
            }

            try {
                const response = await fetch('/api/user/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('å¯†ç¢¼ä¿®æ”¹æˆåŠŸ', 'success');
                    closeModal('passwordModal');
                } else {
                    showMessage(data.message || 'ä¿®æ”¹å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç¢¼å¤±æ•—:', error);
                showMessage('ä¿®æ”¹å¤±æ•—,è«‹é‡è©¦', 'error');
            }
        }

        // é–‹å•Ÿç³»çµ±è¨­å®š
        async function openSettingsModal() {
            openModal('settingsModal');
            try {
                const response = await fetch('/api/user/settings');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('settingNotifications').checked = data.settings.notifications;
                    document.getElementById('settingEmailNotifications').checked = data.settings.email_notifications || false;
                    document.getElementById('settingTheme').value = data.settings.theme || 'default';
                    document.getElementById('settingLanguage').value = data.settings.language || 'zh-TW';
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            }
        }

        // å„²å­˜è¨­å®š
        async function saveSettings() {
            const oldLang = currentLang;
            const newLang = document.getElementById('settingLanguage').value;
            const settings = {
                notifications: document.getElementById('settingNotifications').checked,
                email_notifications: document.getElementById('settingEmailNotifications').checked,
                theme: document.getElementById('settingTheme').value,
                language: newLang
            };

            try {
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(translations.settings_saved || 'è¨­å®šå·²å„²å­˜', 'success');
                    closeModal('settingsModal');

                    // å¦‚æœèªè¨€æ”¹è®Šäº†,é‡æ–°è¼‰å…¥é é¢ä»¥å¥—ç”¨æ–°èªè¨€
                    if (oldLang !== newLang) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } else {
                    showMessage(data.message || translations.settings_save_failed || 'å„²å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('å„²å­˜è¨­å®šå¤±æ•—:', error);
                showMessage(translations.settings_save_failed || 'å„²å­˜å¤±æ•—,è«‹é‡è©¦', 'error');
            }
        }

        // é–‹å•Ÿæ´»å‹•è¨˜éŒ„
        async function openActivitiesModal() {
            openModal('activitiesModal');
            const listDiv = document.getElementById('activitiesList');
            listDiv.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';

            try {
                const response = await fetch('/api/user/activities');
                const data = await response.json();

                if (data.success) {
                    if (data.activities.length === 0) {
                        listDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">æš«ç„¡æ´»å‹•è¨˜éŒ„</p>';
                    } else {
                        listDiv.innerHTML = data.activities.map(activity => `
                            <div class="activity-item">
                                <div class="activity-header">
                                    <span>${getActivityIcon(activity.type)} ${getActivityTypeName(activity.type)}</span>
                                </div>
                                <div class="activity-description">${activity.description}</div>
                                <div class="activity-time">
                                    ${new Date(activity.timestamp).toLocaleString('zh-TW')}
                                    ${activity.ip_address ? ` Â· IP: ${activity.ip_address}` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    listDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">è¼‰å…¥å¤±æ•—</p>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æ´»å‹•è¨˜éŒ„å¤±æ•—:', error);
                listDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // æ´»å‹•é¡å‹åœ–ç¤º
        function getActivityIcon(type) {
            const icons = {
                'login': 'ğŸ”‘',
                'logout': 'ğŸ‘‹',
                'profile_update': 'âœï¸',
                'password_change': 'ğŸ”’',
                'settings_update': 'âš™ï¸',
                'korean_graph': 'ğŸ‡°ğŸ‡·',
                'chinese_graph': 'ğŸ‡¨ğŸ‡³',
                'tts_generate': 'ğŸ™ï¸'
            };
            return icons[type] || 'ğŸ“';
        }

        // æ´»å‹•é¡å‹åç¨±
        function getActivityTypeName(type) {
            const names = {
                'login': 'ç™»å…¥',
                'logout': 'ç™»å‡º',
                'profile_update': 'è³‡æ–™æ›´æ–°',
                'password_change': 'å¯†ç¢¼ä¿®æ”¹',
                'settings_update': 'è¨­å®šæ›´æ–°',
                'korean_graph': 'éŸ“æ–‡åœ–è­œ',
                'chinese_graph': 'ä¸­æ–‡åœ–è­œ',
                'tts_generate': 'TTS ç”Ÿæˆ'
            };
            return names[type] || 'å…¶ä»–';
        }

        // é–‹å•Ÿèªªæ˜ä¸­å¿ƒ
        function openHelpModal() {
            openModal('helpModal');
        }

        // åˆ‡æ›èªªæ˜é …ç›®
        function toggleHelp(element) {
            element.classList.toggle('active');
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            try {
                const response = await fetch('/api/check_auth');
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:', error);
            }
        }

        // æ‰“é–‹éŠæˆ²é¸æ“‡æ¨¡æ…‹è¦–çª—
        function openGamesModal() {
            openModal('gamesModal');
        }

        // æ‰“é–‹ Railway æ‡‰ç”¨ï¼ˆå‚³éç”¨æˆ¶åï¼‰
        function openRailwayApp(appType) {
            // å¾å¾Œç«¯ç²å– Railway URL
            const RAILWAY_URL = "{{ railway_url }}";

            // æ ¹æ“šç’°å¢ƒæ±ºå®šä½¿ç”¨å“ªå€‹ç¶²å€
            const railwayUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:5000'  // æœ¬åœ°é–‹ç™¼
                : RAILWAY_URL;  // ç”Ÿç”¢ç’°å¢ƒ

            // æ§‹å»ºå®Œæ•´ URL ä¸¦å‚³éç”¨æˆ¶å
            const url = `${railwayUrl}/${appType}?user=${encodeURIComponent(username)}`;
            window.open(url, '_blank');
        }

        // åˆå§‹åŒ–
        updateTime();
        setInterval(updateTime, 1000);
        loadStats();
        setInterval(checkAuth, 5 * 60 * 1000);
    </script>
</body>
</html>
