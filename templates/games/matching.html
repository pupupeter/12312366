<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…å°éŠæˆ² - å–®å­—é…å°æŒ‘æˆ°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
        }

        .header .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .game-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 20px;
        }

        .card-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .card {
            padding: 20px;
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 18px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .card:hover:not(.matched):not(.disabled) {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card.selected {
            border-color: #667eea;
            background: #e8eaf6;
            transform: scale(1.05);
        }

        .card.matched {
            background: #c8e6c9;
            border-color: #4caf50;
            cursor: default;
            opacity: 0.7;
        }

        .card.wrong {
            background: #ffcdd2;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .card.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .card-content {
            font-weight: 500;
        }

        .card.korean .card-content {
            color: #667eea;
            font-size: 22px;
        }

        .card.chinese .card-content {
            color: #764ba2;
        }

        .message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        .message.success {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .message.complete {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .language-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .language-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .language-btn.active {
            background: #667eea;
            color: white;
        }

        .language-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® é…å°éŠæˆ²</h1>
            <div class="controls">
                <span>ç”¨æˆ¶: <strong>{{ username }}</strong></span>
                <button class="btn btn-primary" onclick="startNewGame()">ğŸ”„ æ–°éŠæˆ²</button>
                <a href="/games" class="btn btn-secondary">â† è¿”å›é¸å–®</a>
            </div>
        </div>

        <div class="game-container">
            <div class="language-selector">
                <button class="language-btn active" data-lang="korean" onclick="selectLanguage('korean')">
                    ğŸ‡°ğŸ‡· éŸ“æ–‡å–®å­—
                </button>
                <button class="language-btn" data-lang="chinese" onclick="selectLanguage('chinese')">
                    ğŸ‡¨ğŸ‡³ ä¸­æ–‡å–®å­—
                </button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="matched-count">0</div>
                    <div class="stat-label">å·²é…å°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-count">0</div>
                    <div class="stat-label">ç¸½æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="attempts">0</div>
                    <div class="stat-label">å˜—è©¦æ¬¡æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy">100%</div>
                    <div class="stat-label">æ­£ç¢ºç‡</div>
                </div>
            </div>

            <div id="message"></div>
            <div id="game-area"></div>
        </div>
    </div>

    <script>
        let words = [];
        let selectedCards = [];
        let matchedPairs = 0;
        let attempts = 0;
        let correctAttempts = 0;
        let currentLanguage = 'korean';

        // é¸æ“‡èªè¨€
        function selectLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.language-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            loadWords();
        }

        // è¼‰å…¥å–®å­—
        async function loadWords() {
            const gameArea = document.getElementById('game-area');
            gameArea.innerHTML = '<div class="loading">â³ è¼‰å…¥å–®å­—ä¸­...</div>';

            try {
                const endpoint = currentLanguage === 'korean'
                    ? '/korean-app/api/saved-words'
                    : '/chinese-app/api/saved-words';

                const response = await fetch(endpoint);
                const data = await response.json();
                words = data.words || [];

                if (words.length === 0) {
                    gameArea.innerHTML = `
                        <div class="message">
                            ğŸ“š æ‚¨é‚„æ²’æœ‰æ”¶è—ä»»ä½•${currentLanguage === 'korean' ? 'éŸ“æ–‡' : 'ä¸­æ–‡'}å–®å­—<br>
                            <a href="${currentLanguage === 'korean' ? '/korean-app' : '/chinese-app'}"
                               class="btn btn-primary" style="margin-top: 20px;">
                                å»æ”¶è—å–®å­—
                            </a>
                        </div>`;
                    return;
                }

                startNewGame();
            } catch (error) {
                console.error('è¼‰å…¥å–®å­—å¤±æ•—:', error);
                gameArea.innerHTML = '<div class="message">âŒ è¼‰å…¥å–®å­—å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</div>';
            }
        }

        // é–‹å§‹æ–°éŠæˆ²
        function startNewGame() {
            if (words.length === 0) {
                loadWords();
                return;
            }

            // é‡ç½®éŠæˆ²ç‹€æ…‹
            selectedCards = [];
            matchedPairs = 0;
            attempts = 0;
            correctAttempts = 0;

            // éš¨æ©Ÿé¸æ“‡æœ€å¤š 8 å€‹å–®å­—
            const gameWords = [...words].sort(() => Math.random() - 0.5).slice(0, 8);

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('total-count').textContent = gameWords.length;
            document.getElementById('matched-count').textContent = '0';
            document.getElementById('attempts').textContent = '0';
            document.getElementById('accuracy').textContent = '100%';
            document.getElementById('message').innerHTML = '';

            // å‰µå»ºå¡ç‰‡
            renderCards(gameWords);
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards(gameWords) {
            const gameArea = document.getElementById('game-area');

            // æº–å‚™å·¦å³å…©åˆ—çš„å¡ç‰‡
            const leftCards = gameWords.map((word, index) => ({
                id: `left-${index}`,
                wordId: index,
                type: 'left',
                content: currentLanguage === 'korean' ? word.korean : word.chinese,
                className: 'korean'
            }));

            const rightCards = gameWords.map((word, index) => ({
                id: `right-${index}`,
                wordId: index,
                type: 'right',
                content: currentLanguage === 'korean' ? word.chinese : word.definition,
                className: 'chinese'
            }));

            // æ‰“äº‚å³å´å¡ç‰‡
            rightCards.sort(() => Math.random() - 0.5);

            // æ¸²æŸ“ç¶²æ ¼
            gameArea.innerHTML = `
                <div class="game-grid">
                    <div class="card-column" id="left-column"></div>
                    <div class="card-column" id="right-column"></div>
                </div>
            `;

            const leftColumn = document.getElementById('left-column');
            const rightColumn = document.getElementById('right-column');

            leftCards.forEach(card => {
                leftColumn.appendChild(createCardElement(card));
            });

            rightCards.forEach(card => {
                rightColumn.appendChild(createCardElement(card));
            });
        }

        // å‰µå»ºå¡ç‰‡å…ƒç´ 
        function createCardElement(cardData) {
            const card = document.createElement('div');
            card.className = `card ${cardData.className}`;
            card.dataset.id = cardData.id;
            card.dataset.wordId = cardData.wordId;
            card.dataset.type = cardData.type;
            card.innerHTML = `<div class="card-content">${cardData.content}</div>`;
            card.onclick = () => selectCard(cardData);
            return card;
        }

        // é¸æ“‡å¡ç‰‡
        function selectCard(cardData) {
            const cardElement = document.querySelector(`[data-id="${cardData.id}"]`);

            // æª¢æŸ¥å¡ç‰‡æ˜¯å¦å¯é¸
            if (cardElement.classList.contains('matched') ||
                cardElement.classList.contains('disabled')) {
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡
            if (selectedCards.some(c => c.id === cardData.id)) {
                // å–æ¶ˆé¸æ“‡
                cardElement.classList.remove('selected');
                selectedCards = selectedCards.filter(c => c.id !== cardData.id);
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²é¸æ“‡å…©å¼µ
            if (selectedCards.length >= 2) {
                return;
            }

            // é¸æ“‡å¡ç‰‡
            cardElement.classList.add('selected');
            selectedCards.push(cardData);

            // å¦‚æœé¸æ“‡äº†å…©å¼µï¼Œæª¢æŸ¥é…å°
            if (selectedCards.length === 2) {
                checkMatch();
            }
        }

        // æª¢æŸ¥é…å°
        function checkMatch() {
            attempts++;
            document.getElementById('attempts').textContent = attempts;

            const [card1, card2] = selectedCards;

            // ç¦ç”¨æ‰€æœ‰å¡ç‰‡
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('disabled');
            });

            // æª¢æŸ¥æ˜¯å¦é…å°æˆåŠŸï¼ˆä¸€å¼µä¾†è‡ªå·¦é‚Šï¼Œä¸€å¼µä¾†è‡ªå³é‚Šï¼Œä¸” wordId ç›¸åŒï¼‰
            const isMatch = card1.type !== card2.type && card1.wordId === card2.wordId;

            setTimeout(() => {
                const card1Element = document.querySelector(`[data-id="${card1.id}"]`);
                const card2Element = document.querySelector(`[data-id="${card2.id}"]`);

                if (isMatch) {
                    // é…å°æˆåŠŸ
                    correctAttempts++;
                    card1Element.classList.remove('selected');
                    card2Element.classList.remove('selected');
                    card1Element.classList.add('matched');
                    card2Element.classList.add('matched');

                    matchedPairs++;
                    document.getElementById('matched-count').textContent = matchedPairs;

                    showMessage('âœ… é…å°æ­£ç¢ºï¼', 'success');

                    // æª¢æŸ¥æ˜¯å¦å®Œæˆ
                    if (matchedPairs === words.slice(0, 8).length) {
                        setTimeout(() => {
                            const accuracy = Math.round((correctAttempts / attempts) * 100);
                            showMessage(`ğŸ‰ æ­å–œå®Œæˆï¼<br>æ­£ç¢ºç‡: ${accuracy}%`, 'complete');
                        }, 500);
                    }
                } else {
                    // é…å°éŒ¯èª¤
                    card1Element.classList.add('wrong');
                    card2Element.classList.add('wrong');

                    showMessage('âŒ é…å°éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡', 'error');

                    setTimeout(() => {
                        card1Element.classList.remove('selected', 'wrong');
                        card2Element.classList.remove('selected', 'wrong');
                    }, 1000);
                }

                // æ›´æ–°æ­£ç¢ºç‡
                const accuracy = Math.round((correctAttempts / attempts) * 100);
                document.getElementById('accuracy').textContent = accuracy + '%';

                // é‡æ–°å•Ÿç”¨æœªé…å°çš„å¡ç‰‡
                setTimeout(() => {
                    document.querySelectorAll('.card:not(.matched)').forEach(card => {
                        card.classList.remove('disabled');
                    });
                    selectedCards = [];
                }, 500);

            }, 600);
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = text;
            messageDiv.className = `message ${type}`;

            if (type !== 'complete') {
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                    messageDiv.className = 'message';
                }, 2000);
            }
        }

        // é é¢è¼‰å…¥æ™‚é–‹å§‹éŠæˆ²
        window.onload = () => {
            loadWords();
        };
    </script>
</body>
</html>
